version: '3.9'

services:
  astra-landing:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
        # Pass NEXT_PUBLIC_* vars as build args (embedded at build time)
        NEXT_PUBLIC_TAWK_PROPERTY_ID: ${NEXT_PUBLIC_TAWK_PROPERTY_ID}
        NEXT_PUBLIC_TAWK_WIDGET_ID: ${NEXT_PUBLIC_TAWK_WIDGET_ID}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3001}
        NEXT_PUBLIC_SITE_NAME: ${NEXT_PUBLIC_SITE_NAME:-Astra}
        NEXT_PUBLIC_CONTACT_EMAIL: ${NEXT_PUBLIC_CONTACT_EMAIL}
        NEXT_PUBLIC_GA_ID: ${NEXT_PUBLIC_GA_ID}
        NEXT_PUBLIC_PLAUSIBLE_DOMAIN: ${NEXT_PUBLIC_PLAUSIBLE_DOMAIN}
        NEXT_PUBLIC_HOTJAR_ID: ${NEXT_PUBLIC_HOTJAR_ID}
    container_name: astra-landing
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      # Site Configuration
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3001}
      - NEXT_PUBLIC_SITE_NAME=${NEXT_PUBLIC_SITE_NAME:-Astra}
      - NEXT_PUBLIC_CONTACT_EMAIL=${NEXT_PUBLIC_CONTACT_EMAIL}

      # Email Service (Resend)
      - RESEND_API_KEY=${RESEND_API_KEY}
      - RESEND_FROM_EMAIL=${RESEND_FROM_EMAIL}

      # Analytics (Optional)
      - NEXT_PUBLIC_GA_ID=${NEXT_PUBLIC_GA_ID}
      - NEXT_PUBLIC_PLAUSIBLE_DOMAIN=${NEXT_PUBLIC_PLAUSIBLE_DOMAIN}
      - NEXT_PUBLIC_HOTJAR_ID=${NEXT_PUBLIC_HOTJAR_ID}

      # Tawk.to Live Chat (FREE)
      - NEXT_PUBLIC_TAWK_PROPERTY_ID=${NEXT_PUBLIC_TAWK_PROPERTY_ID}
      - NEXT_PUBLIC_TAWK_WIDGET_ID=${NEXT_PUBLIC_TAWK_WIDGET_ID}

      # Feature Flags (Optional)
      - NEXT_PUBLIC_ENABLE_CONTACT_FORM=${NEXT_PUBLIC_ENABLE_CONTACT_FORM:-true}
      - NEXT_PUBLIC_ENABLE_DEMO_BOOKING=${NEXT_PUBLIC_ENABLE_DEMO_BOOKING:-true}
      - NEXT_PUBLIC_ENABLE_ROI_CALCULATOR=${NEXT_PUBLIC_ENABLE_ROI_CALCULATOR:-true}

      # Production settings
      - NODE_ENV=production
    env_file:
      - .env.local
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    networks:
      - astra-network
    labels:
      - "com.astra.description=Astra Landing Page"
      - "com.astra.version=1.0.0"

networks:
  astra-network:
    driver: bridge
